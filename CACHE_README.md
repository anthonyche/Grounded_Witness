# Subgraph Cache System

## æ¦‚è¿°

ä¸ºäº†é¿å…é‡å¤æå–å­å›¾ï¼ˆè€—æ—¶ 1000+ ç§’ï¼‰ï¼Œæˆ‘ä»¬å®ç°äº†å­å›¾ç¼“å­˜ç³»ç»Ÿã€‚ç¬¬ä¸€æ¬¡è¿è¡Œä¼šæå–å¹¶ä¿å­˜å­å›¾ï¼Œåç»­è¿è¡Œç›´æ¥ä»ç¼“å­˜åŠ è½½ã€‚

## ç¼“å­˜æœºåˆ¶

### ç¼“å­˜æ–‡ä»¶å‘½å
```
cache/subgraphs/subgraphs_hops{L}_nodes{N}_hash{H}.pt
```

ç¤ºä¾‹ï¼š
```
cache/subgraphs/subgraphs_hops2_nodes100_hash123456789.pt
```

### ç¼“å­˜é”®å€¼
- **num_hops**: L-hop æ•°ï¼ˆå¦‚ 2-hopï¼‰
- **num_nodes**: é‡‡æ ·èŠ‚ç‚¹æ•°ï¼ˆå¦‚ 100ï¼‰
- **hash**: èŠ‚ç‚¹ ID åˆ—è¡¨çš„å“ˆå¸Œå€¼ï¼ˆç¡®ä¿å”¯ä¸€æ€§ï¼‰

### è‡ªåŠ¨ç¼“å­˜é€»è¾‘

1. **é¦–æ¬¡è¿è¡Œ**: 
   - æå– 100 ä¸ª 2-hop å­å›¾ï¼ˆ~1097ç§’ï¼‰
   - ä¿å­˜åˆ° `cache/subgraphs/*.pt`
   - ç»§ç»­è¿è¡Œ benchmark

2. **åç»­è¿è¡Œ**:
   - æ£€æµ‹åˆ°ç¼“å­˜æ–‡ä»¶å­˜åœ¨
   - ç›´æ¥åŠ è½½ï¼ˆ~1-2ç§’ï¼‰
   - èŠ‚çœ 99% æå–æ—¶é—´ï¼

## æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æå–æ—¶é—´ | åŠ é€Ÿ |
|------|---------|------|
| **æ— ç¼“å­˜** (ç¬¬1æ¬¡) | 1097ç§’ | 1.0x |
| **æœ‰ç¼“å­˜** (ç¬¬2+æ¬¡) | ~2ç§’ | **550x** âš¡ |

## ä½¿ç”¨ç¼“å­˜ç®¡ç†å·¥å…·

### åˆ—å‡ºæ‰€æœ‰ç¼“å­˜
```bash
python manage_cache.py list
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
Found 2 cache file(s) in cache/subgraphs:

Filename                                                     Size         Modified            
-----------------------------------------------------------------------------------------------
subgraphs_hops2_nodes100_hash123456789.pt                   245.50 MB    2025-10-23 17:43:00
subgraphs_hops2_nodes50_hash987654321.pt                    122.75 MB    2025-10-22 10:15:30
-----------------------------------------------------------------------------------------------
Total cache size: 368.25 MB
```

### æŸ¥çœ‹ç¼“å­˜è¯¦æƒ…
```bash
python manage_cache.py info cache/subgraphs/subgraphs_hops2_nodes100_hash123456789.pt
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
Cache File Information:
============================================================
File size: 245.50 MB
Number of tasks: 100
Number of hops: 2
Number of node IDs: 100
Created: 2025-10-23 17:43:00

Subgraph Statistics:
  Min edges: 1250
  Max edges: 8920
  Mean edges: 4532.5

Node IDs (first 10): [105525684, 98234567, ...]
```

### æ¸…ç†æ‰€æœ‰ç¼“å­˜
```bash
python manage_cache.py clean
```

### æ¸…ç†æ—§ç¼“å­˜ï¼ˆ7å¤©å‰ï¼‰
```bash
python manage_cache.py clean-old        # é»˜è®¤ 7 å¤©
python manage_cache.py clean-old 30     # è‡ªå®šä¹‰ 30 å¤©
```

## ç¼“å­˜å¤±æ•ˆåœºæ™¯

ç¼“å­˜ä¼šåœ¨ä»¥ä¸‹æƒ…å†µå¤±æ•ˆï¼ˆè‡ªåŠ¨é‡æ–°æå–ï¼‰ï¼š

1. âŒ **èŠ‚ç‚¹ ID åˆ—è¡¨æ”¹å˜**: ä¸åŒçš„é‡‡æ ·èŠ‚ç‚¹
2. âŒ **Hop æ•°æ”¹å˜**: L ä» 2 å˜ä¸º 3
3. âŒ **èŠ‚ç‚¹æ•°é‡æ”¹å˜**: ä» 100 å˜ä¸º 50
4. âœ… **Worker æ•°é‡æ”¹å˜**: ä¸å½±å“ï¼ˆå…±äº«åŒä¸€ç¼“å­˜ï¼‰
5. âœ… **Explainer æ”¹å˜**: ä¸å½±å“ï¼ˆå…±äº«åŒä¸€ç¼“å­˜ï¼‰

## ç¼“å­˜æ–‡ä»¶ç»“æ„

```python
cache_data = {
    'tasks': List[SubgraphTask],       # ä»»åŠ¡åˆ—è¡¨ï¼ˆåŒ…å«å­å›¾ï¼‰
    'node_ids': List[int],             # åŸå§‹èŠ‚ç‚¹ ID
    'num_hops': int,                   # L-hop æ•°
    'metadata': {
        'num_tasks': int,              # ä»»åŠ¡æ•°é‡
        'timestamp': float,            # åˆ›å»ºæ—¶é—´æˆ³
    }
}
```

## ç£ç›˜ç©ºé—´ä¼°ç®—

- **100 èŠ‚ç‚¹, 2-hop**: ~200-300 MB
- **500 èŠ‚ç‚¹, 2-hop**: ~1-1.5 GB
- **1000 èŠ‚ç‚¹, 2-hop**: ~2-3 GB

å»ºè®®ä¿ç•™è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘ 10GBï¼‰ã€‚

## ä¸ HPC é›†æˆ

### Slurm ä½œä¸šä¸­è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜

```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆåˆ›å»ºç¼“å­˜ï¼‰
sbatch run_ogbn_distributed_bench.slurm

# åç»­è¿è¡Œï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
sbatch run_ogbn_distributed_bench.slurm  # è‡ªåŠ¨åŠ è½½
```

### å…±äº«ç¼“å­˜ï¼ˆå¤šç”¨æˆ·ï¼‰

å¦‚æœå›¢é˜Ÿå…±äº« HPC å­˜å‚¨ï¼š

```bash
# è®¾ç½®å…±äº«ç¼“å­˜ç›®å½•
export CACHE_DIR=/shared/cache/subgraphs

# ä¿®æ”¹ config.yaml æˆ–ä»£ç ä¸­çš„ cache_dir
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç¼“å­˜åŠ è½½å¤±è´¥
```
Warning: Failed to load cache: ...
Will extract subgraphs from scratch...
```

**è§£å†³**: ç¼“å­˜æ–‡ä»¶æŸåï¼Œè‡ªåŠ¨é‡æ–°æå–ã€‚

### é—®é¢˜ 2: å†…å­˜ä¸è¶³
```
ERROR: Out of memory when loading cache
```

**è§£å†³**: 
1. æ¸…ç†æ—§ç¼“å­˜ï¼š`python manage_cache.py clean-old`
2. å‡å°‘ `num_target_nodes` åœ¨ config.yaml

### é—®é¢˜ 3: ç£ç›˜ç©ºé—´ä¸è¶³
```
ERROR: No space left on device
```

**è§£å†³**:
```bash
# æ£€æŸ¥ç¼“å­˜å¤§å°
python manage_cache.py list

# æ¸…ç†ç¼“å­˜
python manage_cache.py clean
```

## æœ€ä½³å®è·µ

1. âœ… **é¦–æ¬¡è¿è¡Œå°è§„æ¨¡æµ‹è¯•**: `num_target_nodes: 10`
2. âœ… **éªŒè¯ç¼“å­˜**: `python manage_cache.py list`
3. âœ… **å®šæœŸæ¸…ç†**: æ¯å‘¨è¿è¡Œ `clean-old`
4. âœ… **å¤‡ä»½é‡è¦ç¼“å­˜**: å¤åˆ¶åˆ°å®‰å…¨ä½ç½®
5. âš ï¸ **ä¸è¦æ‰‹åŠ¨ç¼–è¾‘**: ç¼“å­˜æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ ¼å¼

## æ€§èƒ½æå‡æ€»ç»“

### å•æ¬¡ Benchmark
- **æ— ç¼“å­˜**: 1097s (æå–) + 35s (è®¡ç®—) = 1132s
- **æœ‰ç¼“å­˜**: 2s (åŠ è½½) + 35s (è®¡ç®—) = 37s
- **æå‡**: **30x åŠ é€Ÿ** ğŸš€

### 15 æ¬¡å®Œæ•´æµ‹è¯• (3 explainers Ã— 5 workers)
- **æ— ç¼“å­˜**: 1097s Ã— 15 = 16,455s â‰ˆ **4.6 å°æ—¶**
- **æœ‰ç¼“å­˜**: 1097s (ç¬¬1æ¬¡) + 2s Ã— 14 = 1125s â‰ˆ **19 åˆ†é’Ÿ**
- **èŠ‚çœ**: **14.6å€æ—¶é—´** âš¡

## æ€»ç»“

ç¼“å­˜ç³»ç»Ÿè®©æ‚¨çš„ benchmark ä» **5å°æ—¶** ç¼©çŸ­åˆ° **20åˆ†é’Ÿ**ï¼Œæå¤§æå‡ç ”ç©¶æ•ˆç‡ï¼ğŸ‰
