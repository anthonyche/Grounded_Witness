# TreeCycle Benchmark v2 - å…³é”®ä¿®å¤

## ä¿®å¤çš„é—®é¢˜

### 1. âœ… GPU/CPU è®¾å¤‡ä¸åŒ¹é…é”™è¯¯

**é—®é¢˜**:
```
Expected all tensors to be on the same device, but found at least two devices, cpu and cuda:0!
```

**åŸå› **:
- å­å›¾æ•°æ®åœ¨ CPU
- æ¨¡å‹åœ¨ GPU  
- PyTorch ä¸ä¼šè‡ªåŠ¨ä¼ è¾“æ•°æ®

**è§£å†³æ–¹æ¡ˆ**: åˆ›å»º HybridGCN åŒ…è£…å™¨

```python
class HybridGCN(torch.nn.Module):
    """è‡ªåŠ¨å¤„ç† CPU æ•°æ®å’Œ GPU æ¨¡å‹çš„æ¨ç†"""
    def __init__(self, base_model, model_device, data_device):
        super().__init__()
        self.base_model = base_model
        self.model_device = model_device
        self.data_device = data_device
    
    def forward(self, x, edge_index):
        # 1. æ•°æ®ä¸´æ—¶ç§»åˆ° GPU
        x = x.to(self.model_device)
        edge_index = edge_index.to(self.model_device)
        
        # 2. GPU æ¨ç†
        out = self.base_model(x, edge_index)
        
        # 3. ç»“æœç§»å› CPU
        out = out.to(self.data_device)
        return out
```

**ä¼˜åŠ¿**:
- âœ… æ•°æ®ä¿æŒåœ¨ CPUï¼ˆé¿å… CUDA å¤šè¿›ç¨‹æ­»é”ï¼‰
- âœ… æ¨¡å‹æ¨ç†ç”¨ GPUï¼ˆåŠ é€Ÿï¼‰
- âœ… è‡ªåŠ¨æ•°æ®ä¼ è¾“ï¼ˆé€æ˜ï¼‰

### 2. âœ… ç¼“å­˜ç­–ç•¥ï¼ˆé¿å…é‡å¤é‡‡æ ·ï¼‰

**é—®é¢˜**:
- æ¯æ¬¡è¿è¡Œéƒ½é‡æ–°æå–å­å›¾
- L-hop neighbors ä¸ä¸€è‡´
- æµªè´¹æ—¶é—´å’Œè®¡ç®—èµ„æº

**è§£å†³æ–¹æ¡ˆ**: é‡‡ç”¨ OGBN çš„ç¼“å­˜æœºåˆ¶

```python
# ç¼“å­˜æ–‡ä»¶è·¯å¾„
cache_path = 'cache/treecycle/subgraphs_n100_h2_seed42.pkl'

if os.path.exists(cache_path):
    # ä»ç¼“å­˜åŠ è½½
    with open(cache_path, 'rb') as f:
        cached_data = pickle.load(f)
    sampled_nodes = cached_data['sampled_nodes']
    tasks = cached_data['tasks']
else:
    # é¦–æ¬¡è¿è¡Œï¼šæå–å­å›¾å¹¶ä¿å­˜
    tasks = coordinator.create_tasks(sampled_nodes)
    cached_data = {
        'sampled_nodes': sampled_nodes,
        'tasks': tasks,
        'num_targets': NUM_TARGETS,
        'num_hops': NUM_HOPS,
        'seed': 42
    }
    with open(cache_path, 'wb') as f:
        pickle.dump(cached_data, f)
```

**ä¼˜åŠ¿**:
- âœ… **ä¸€è‡´æ€§**: åŒæ ·çš„ NUM_TARGETS å’Œ NUM_HOPSï¼Œä½¿ç”¨ç›¸åŒçš„å­å›¾
- âœ… **é€Ÿåº¦**: é¿å…é‡å¤æå–ï¼ˆé¦–æ¬¡ ~60sï¼Œåç»­ ~1sï¼‰
- âœ… **å¯æ¯”æ€§**: ä¸åŒ explainer æµ‹è¯•ç›¸åŒçš„å­å›¾é›†åˆ

**ç¼“å­˜æ–‡ä»¶å‘½å**:
```
cache/treecycle/subgraphs_n{NUM_TARGETS}_h{NUM_HOPS}_seed42.pkl
```

## å·¥ä½œæµç¨‹

### é¦–æ¬¡è¿è¡Œï¼ˆæå–å­å›¾ï¼‰
```
1. æ£€æŸ¥ç¼“å­˜ï¼šä¸å­˜åœ¨
2. åŠ è½½ TreeCycle å›¾ï¼ˆ813K nodesï¼‰
3. å›ºå®š seed=42 é‡‡æ · 100 ä¸ªèŠ‚ç‚¹
4. æå– 100 ä¸ª 2-hop å­å›¾ï¼ˆ~60sï¼‰
5. ä¿å­˜åˆ°ç¼“å­˜
6. è¿è¡Œ benchmark
```

### åç»­è¿è¡Œï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
```
1. æ£€æŸ¥ç¼“å­˜ï¼šå­˜åœ¨
2. ç›´æ¥ä»ç¼“å­˜åŠ è½½ 100 ä¸ªå­å›¾ï¼ˆ~1sï¼‰
3. è¿è¡Œ benchmark
```

### æ”¹å˜å‚æ•°æ—¶
å¦‚æœä¿®æ”¹ `NUM_TARGETS` æˆ– `NUM_HOPS`ï¼š
- ç¼“å­˜æ–‡ä»¶åæ”¹å˜
- è‡ªåŠ¨é‡æ–°æå–å­å›¾
- ä¿å­˜æ–°çš„ç¼“å­˜æ–‡ä»¶

ä¾‹å¦‚ï¼š
- `NUM_TARGETS=100, NUM_HOPS=2` â†’ `subgraphs_n100_h2_seed42.pkl`
- `NUM_TARGETS=200, NUM_HOPS=3` â†’ `subgraphs_n200_h3_seed42.pkl`ï¼ˆæ–°æ–‡ä»¶ï¼‰

## æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¦–æ¬¡è¿è¡Œæˆ–å‚æ•°æ”¹å˜                                  â”‚
â”‚  â”œâ”€ åŠ è½½å®Œæ•´å›¾ (CPU)                                â”‚
â”‚  â”œâ”€ é‡‡æ ·èŠ‚ç‚¹ (seed=42)                              â”‚
â”‚  â”œâ”€ æå– L-hop å­å›¾ (CPU)                           â”‚
â”‚  â””â”€ ä¿å­˜åˆ°ç¼“å­˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»ç¼“å­˜åŠ è½½ (åç»­è¿è¡Œ)                              â”‚
â”‚  â””â”€ tasks = [SubgraphTaskâ‚, ..., SubgraphTask_n]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†é…ä»»åŠ¡åˆ° Workers (CPU)                           â”‚
â”‚  â”œâ”€ Worker 1: tasks[0:5]   (CPU)                    â”‚
â”‚  â”œâ”€ Worker 2: tasks[5:10]  (CPU)                    â”‚
â”‚  â””â”€ ...                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¯ä¸ª Worker çš„æ¨ç†æµç¨‹                             â”‚
â”‚  â”œâ”€ åŠ è½½æ¨¡å‹ â†’ GPU                                  â”‚
â”‚  â”œâ”€ å­å›¾æ•°æ® â†’ CPU                                  â”‚
â”‚  â””â”€ æ¯ä¸ªä»»åŠ¡:                                       â”‚
â”‚     â”œâ”€ HybridGCN.forward()                         â”‚
â”‚     â”‚   â”œâ”€ x, edge_index â†’ GPU (ä¸´æ—¶)              â”‚
â”‚     â”‚   â”œâ”€ model(x, edge_index) [GPUæ¨ç†]          â”‚
â”‚     â”‚   â””â”€ output â†’ CPU                            â”‚
â”‚     â”œâ”€ HeuChase/ApxChase._run() [CPU]              â”‚
â”‚     â””â”€ è¿”å›ç»“æœ [CPU]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ€§èƒ½å¯¹æ¯”

### ä¹‹å‰ï¼ˆæ— ç¼“å­˜ + è®¾å¤‡é”™è¯¯ï¼‰
- âŒ æ¯æ¬¡è¿è¡Œæå–å­å›¾: ~60s
- âŒ è®¾å¤‡ä¸åŒ¹é…é”™è¯¯: ç«‹å³å¤±è´¥
- âŒ ä¸åŒè¿è¡Œå­å›¾ä¸ä¸€è‡´

### ç°åœ¨ï¼ˆç¼“å­˜ + HybridGCNï¼‰
- âœ… é¦–æ¬¡è¿è¡Œ: ~60s æå– + benchmark
- âœ… åç»­è¿è¡Œ: ~1s åŠ è½½ + benchmark
- âœ… è‡ªåŠ¨ CPU/GPU æ•°æ®ä¼ è¾“
- âœ… å®Œå…¨ä¸€è‡´çš„å­å›¾é›†åˆ

## ä½¿ç”¨æ–¹æ³•

### è¿è¡Œå®Œæ•´ benchmark
```bash
sbatch run_treecycle_distributed_bench.slurm
```

### æŸ¥çœ‹ç¼“å­˜
```bash
ls -lh cache/treecycle/
# subgraphs_n100_h2_seed42.pkl  (~100MB)
```

### åˆ é™¤ç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°æå–ï¼‰
```bash
rm cache/treecycle/subgraphs_n100_h2_seed42.pkl
```

### æ”¹å˜å‚æ•°
```python
# åœ¨ main() ä¸­ä¿®æ”¹
NUM_TARGETS = 200  # ä» 100 æ”¹ä¸º 200
NUM_HOPS = 3       # ä» 2 æ”¹ä¸º 3
# ä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„ç¼“å­˜æ–‡ä»¶
```

## éªŒè¯

### æ£€æŸ¥ HybridGCN å·¥ä½œ
æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
grep "Model wrapped with HybridGCN" logs/*.out
grep "auto data transfer" logs/*.out
```

### æ£€æŸ¥ç¼“å­˜ä½¿ç”¨
æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
grep "Found cached subgraphs" logs/*.out
grep "Loading from cache" logs/*.out
```

### æ£€æŸ¥ä¸€è‡´æ€§
ä¸¤æ¬¡è¿è¡Œåº”è¯¥ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å­å›¾ï¼š
```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œ
sbatch run_treecycle_distributed_bench.slurm

# ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆåº”è¯¥ä»ç¼“å­˜åŠ è½½ï¼‰
sbatch run_treecycle_distributed_bench.slurm
```

## æ€»ç»“

ä¸¤ä¸ªå…³é”®ä¿®å¤ï¼š
1. **HybridGCN**: è§£å†³ GPU/CPU è®¾å¤‡ä¸åŒ¹é…
2. **ç¼“å­˜æœºåˆ¶**: ç¡®ä¿ä¸€è‡´æ€§å’Œé¿å…é‡å¤è®¡ç®—

ç°åœ¨å¯ä»¥ç¨³å®šè¿è¡Œå®Œæ•´çš„ distributed benchmarkï¼ ğŸ‰
